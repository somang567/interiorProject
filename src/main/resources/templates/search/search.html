<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<th:block layout:fragment="css">
  <!-- css 적용 -->
  <style>
    .search-main {
      margin: 40px auto;
      padding: 20px;
      width: 80vw;
      height: 40vh;
      background-color: papayawhip;
      text-align: center;
    }

    #search-dosi,
    #search-googun {
      width: 300px;
      height: 50px;
      margin: 10px;
      padding: 10px 30px;
      border: none;
      border-radius: 20px;
      font-size: large;
    }

    .search-main>h1 {
      font-size: 50px;
      padding: 20px;
    }

    #magnifier {
      width: 100px;
      height: 100px;
      margin-right: 10%;
      display: inline-block;
    }

    #company-name {
      width: 400px;
    }

    #company-name,
    .search-btn {
      height: 50px;
      margin: 10px 15px;
      padding: 10px 30px;
      border-radius: 20px;
      border-width: 1px;
      border: none;
      font-size: large;
      background-color: white;
    }

    .search-btn:hover {
      background-color: #C5BAAA;
    }

    .search-result-btn {
      margin: 40px auto;
      padding: 15px;
      width: 80vw;
      height: 30vh;
      background-color: #C5BAAA;
      border-radius: 30px;
    }
  </style>
</th:block>

<th:block layout:fragment="script">
  <script>
    const googuns = {
      서울: ["강북구", "관악구", "광진구", "금천구", "동작구", "마포구", "서초구", "성동구", "영등포구", "용산구"],
      인천: ["부평구"],
      대전: ["동구", "서구", "유성구", "대덕구"],
      부산: ["강서구", "기장군", "동구", "동래구", "부산진구", "북구", "사상구", "사하구", "서구", "영도구", "중구", "해운대구"],
      충북: ["옥천군"],
      충남: ["부여군"],
      전북: ["익산시"],
      세종: ["세종시"]
    };

    function searchDosi() {
      const dosiSelect = document.getElementById("search-dosi");
      const googunSelect = document.getElementById("search-googun");

      const dosiSelected = dosiSelect.value;

      // 구/군 목록 초기화
      googunSelect.innerHTML = '<option value="">구/군</option>';

      // 선택된 도시의 구/군 목록 추가
      if (googuns[dosiSelected]) {
        googuns[dosiSelected].forEach(googun => {
          const option = document.createElement("option");
          option.value = googun;
          option.textContent = googun;
          googunSelect.appendChild(option);
        });
      }
    }

    function resetSelection() {
      document.getElementById("search-dosi").value = '';
      document.getElementById("search-googun").innerHTML = '<option value="">구/군</option>';
      document.getElementById("company-name").value = '';
    }

    // searchCompany() : 사용자 입력을 확인하고 api 호출하는 함수
    function searchCompany() {
      const dosiSelected = document.getElementById("search-dosi").value;
      const googunSelected = document.getElementById("search-googun").value;

      // 도/시와 구/군을 선택하지 않았을때 뜨는 경고메세지
      if (!dosiSelected || !googunSelected) {
        alert("도/시, 구/군을 선택해주세요.");
        return;
      }

      // JSON 파일 경로
      // const jsonFilePath = 'file:///Users/lkiki/Desktop/interior_API/${dosiSelected}_${googunSelected}.json';

      // AJAX 요청
      fetch(`http://localhost:8586/${dosiSelected}_${googunSelected}.json`)
        .then(response => {
          if (!response.ok) {
            throw new Error('네트워크 응답이 좋지 않습니다.');
          }
          return response.json();
        })
        .then(data => {
          // 업체명으로 필터링 (업체명이 입력된 경우에만)
          // const filteredData = companyName
          //   ? data.filter(item => item.company_name.includes(companyName))
          //   : data; // 업체명이 없으면 전체 데이터 반환

          // 결과 표시
          displayResults(data);
        })
        .catch(error => {
          console.error('문제가 발생했습니다.', error);
        });
    }

    // displayResults() : 결과를 화면에 표시하는 함수
    function displayResults(data) {
      const resultContainer = document.querySelector(".search-result");
      resultContainer.innerHTML = '';       // 기존 결과 초기화

      let results = [];

      // "Sheet1" 키가 있는지 확인하고, 배열이 있는 경우
      if (data && Array.isArray(data["Sheet1"])) {
        results = data["Sheet1"];
      } else if (Array.isArray(data)) {
        // "Sheet1" 키가 없지만, 기본 배열인 경우(기본 json 파일 얘들)
        results = data;
      } else {
        // 유효한 데이터가 아닐 때
        resultContainer.innerHTML = '<p>유효한 데이터가 아닙니다.</p>';
        return;
      }

      // getValue 함수 정의
      function getValue(item, ...fields) {
        for (const field of fields) {
          if (item[field]) {
            return item[field];
          }
        }
        return '';            // json 파일에 해당하는 필드가 전부 없을 경우 ''값 반환
      }

      // 나머지 데이터 처리
      results.forEach(item => {
        const resultDiv = document.createElement('div');
        resultDiv.className = 'search-result-btn';

        const companyName = getValue(item, '업체명', '상호', '상호명');
        const address = getValue(item, '도로명주소', '소재지', '영업소재지주소', '소재지도로명주소', '영업소재지(도로명주소)', '소재지 주소');
        const phone = getValue(item, '전화번호', '연락처');

        resultDiv.innerHTML = `
          <h2><b>${companyName}</b></h2>
          <p>
          <p>${address}</p>
          <p>${phone}</p>
        `;
        resultContainer.appendChild(resultDiv);
      });
    }

  </script>
</th:block>

<div layout:fragment="content">
  <div class="search-main">
    <h1><b>시공업체 찾기</b></h1>
    <br>
    <img id="magnifier" th:src="@{/img/magnifier.png}" alt="돋보기">
    <select id="search-dosi" onchange="searchDosi()">도/시
      <option value="">도/시</option>
      <option value="서울">서울특별시</option>
      <option value="인천">인천광역시</option>
      <option value="대전">대전광역시</option>
      <option value="부산">부산광역시</option>
      <option value="충북">충청북도</option>
      <option value="충남">충청남도</option>
      <option value="전북">전라북도</option>
      <option value="세종">세종특별자치시</option>
    </select>

    <select id="search-googun">
      <option value="">구/군</option>
    </select>
    <p></p>

    <!-- 업체명 입력 필드 추가 -->
    <input type="text" id="company-name" placeholder="업체명을 입력하세요." />

    <!-- 검색 버튼 추가 -->
    <button class="search-btn" onclick="searchCompany()">검색</button>
  </div>

  <div class="search-result">
    <div class="search-result-btn">
      <h3>api 들어가야함1</h3>
      <br>
      <p>(지도 마커 아이콘)</p>
      <p>api</p>
      <p>api</p>
    </div>

    <div class="search-result-btn">
      <h3>api 들어가야함2</h3>
      <br>
      <p>(지도 마커 아이콘)</p>
      <p>api</p>
      <p>api</p>
    </div>

    <div class="search-result-btn">
      <h3>api 들어가야함3</h3>
      <br>
      <p>(지도 마커 아이콘)</p>
      <p>api</p>
      <p>api</p>
    </div>
  </div>

</div>

</html>