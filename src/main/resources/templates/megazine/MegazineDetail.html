<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layouts/layout1}">

<head>
  <meta name="_csrf" th:content="${_csrf.token}" />
  <meta name="_csrf_header" th:content="${_csrf.headerName}"/>
</head>
<!-- 사용 Css 추가 -->
<th:block layout:fragment="css">
  <style>
    .mgt-15{ margin-bottom: 15px;}
    .mgt-30{ margin-top: 30px;}
    .mgt-50{ margin-top: 50px;}
    .repImgDiv{margin-right:15px; height: auto; width:50%;}
    .repImg{ width:100%; height:400px; }
    .wd50{ height:auto; width:50%;}
  </style>
</th:block>

<!-- 사용 Js 추가 -->
<th:block layout:fragment="script">

  <script th:inline="javascript">
    $(document).ready(function(){

      calculateTotalPrice();

      $("#count").change(function(){
         calculateTotalPrice();
      }); //------------------------function ready

    });

    function calculateTotalPrice(){
      const count = $("#count").val();
      const price = $("#price").val();
      const totalPrice = count * price;
      $("#totalPrice").html(totalPrice + "원");
    }

    function order(){
    //Http 문서의 메타 태그에서 Csrf토큰과 헤더 이름을 가져온다.
    //csrf 보호를 위해 서버에 요청을 보낼 때 이 토큰을 사용.
    //_csrf: 서버에서 생성한 CSRF 토큰을 포함하는 메타 태그입니다. 이는 클라이언트가 서버에 요청을 보낼 때 사용됩니다.
    //CSRF 토큰을 HTTP 요청의 헤더에서 가져오는 이유는 보안성과 유효성을 높이기 위해서입니다.
    //CSRF 토큰을 헤더에 포함시키면, 서버는 요청이 신뢰할 수 있는 출처에서 왔는지를 확인할 수 있습니다.

       const token = $("meta[name='_csrf']").attr("content");
       const header = $("meta[name='_csrf_header']").attr("content");

       const url = "/order";  // 주문 요청을 보낼 url을 설정.
       //파라미터 데이터 설정
       const paramData = { itemId : $("#itemId").val(),
                           count : $("#count").val()
                          };

       const param = JSON.stringify(paramData); //먼저 선언을 해줌

       $.ajax({
          url: url,
          type: "POST",
          /*서버에게 보내는 데이터 타입*/
          contentType: "application/json",
          data:param,
          beforeSend: function(xhr) {
            /*데이터를 전송하기 전에 헤더에 csrf 값을 설정*/
            xhr.setRequestHeader(header,token); //토큰을 주고 정상적인 데이터라는 것을 알려줌.
          },
          /*서버에게 결과값으로 받을 데이터 타입*/
          dataType: "json",
          cache: false,
          success: function(result, status){
            alert("주문이 완료되었습니다.");
            location.href='/';
          },
          error: function(xhr, status, error){
              if(xhr.status == '401'){
                alert('로그인 후 주문해주세요.');
                location.href='/members/login';
              } else {
                //alert(xhr.responseText);  //그렇지 않으면 이 화면에 머무르면 됨.
                alert(xhr.status);
                console.log("xhr=====================>" + xhr.responseText);
                console.log("error===================>" + error);
              }
          } //----------error
          //컨트롤러는 화면을 리턴 값으로 다시 불러오기 때문에 ajax로 불러서 화면을 이동하지 않고 그 안에서 이동할 수 있게함.
       })  //----------ajax
    }//-----------------order function


    function addCart(){
      const token = $("meta[name='_csrf']").attr("content");
      const header = $("meta[name='_csrf_header']").attr("content");

      const url = "/cart";
      //보낼 것
      const paramData = {
          itemId : $("#itemId").val(),
          count : $("#count").val()
      };
      const param = JSON.stringify(paramData);

      $.ajax({
        url:url,
        type: "POST",
        contentType: "application/json",
        data: param,
        beforeSend: function(xhr){  //AJAX 요청이 서버로 전송되기 전에 실행되는 콜백 함수
          xhr.setRequestHeader(header, token);  //인증 토큰을 설정.
        },
        dataType: "json",
        cache: false, //매번 요청할 때마다 서버에 새로운 요청을 보내고 응답을 받습니다.
        //데이터가 자주 변경되거나 항상 최신 상태를 유지해야 할 때 유용하게 사용됩니다.
        success: function(result, status){
            alert("상품을 장바구니에 담았습니다.");
            location.href = "/";
        },
        error: function(xhr, status, error){
            if(xhr.status == '401'){
              alert("로그인 후 이용해주세요");
              location.href='/members/login';
            }else{
              alert(xhr.responseText);
            }
        }
      });
    }
  </script>
</th:block>

<div layout:fragment="content" style="margin-left: 25%; margin-right: 25%;">
  <!-- 아이템 모델의 item.java id 정보를 불러와서 hidden으로 처리. -->
  <input type="hidden" id="itemId" th:value="${item.id}">
  <div class="d-flex">
    <div class="repImgDiv">
      <!-- item -> itemDTO 에서 가져옴-->
      <img th:src="${item.itemImgDTOList[0].imgUrl}" th:alt="${item.itemNm}" class="rounded repImg">
    </div>
    <div class="wd50">
        <span class="badge badge-primary mgb-15"
              th:if="${item.itemSellStatus == T(com.keduit.shop.constant.ItemSellStatus).SELL}">판매중</span>
      <span class="badge btn-danger mgb-15"
            th:unless="${item.itemSellStatus == T(com.keduit.shop.constant.ItemSellStatus).SELL}">품절</span>
      <div class="h4" th:text="${item.itemNm}">이름</div>
      <hr class="my-4">

      <div class="text-right">
        <div class="h4 text-danger text-left">
          <input type="hidden" th:value="${item.price}" id="price" name="price">  <!--전달하는 부분 -->
          <span th:text="${item.price}"></span>원 <!--화면에서 보여지는 부분 -->
        </div>

        <div class="input-group w-50">
          <div class="input-group-prepend">
            <span class="input-group-text">수량</span>
          </div>
          <input type="number" class="form-control" name="count" id="count" value="1" min="1">
        </div>
        <hr class="my-4">
        <div class="text-right mgt-50">
          <h5>결제금액</h5>
          <h3 class="font-weight-bold" name="totalPrice" id="totalPrice"></h3>
        </div>
      </div>
      <div class="text-right"
           th:if="${item.itemSellStatus == T(com.keduit.shop.constant.ItemSellStatus).SELL}">
        <button type="button" class="btn btn-light border-primary btn-lg" onclick="addCart()">장바구니 담기</button>
        <button type="button" class="btn btn-primary btn-lg" onclick="order()">주문하기</button>
      </div>
      <div class="text-right"
           th:unless="${item.itemSellStatus == T(com.keduit.shop.constant.ItemSellStatus).SELL}">
        <button type="button" class="btn btn-danger btn-lg">품절</button>
      </div>
    </div>
  </div>

  <div class="jumbotron jumbotron-fluid mgt-30">
    <div class="container">
      <h4 class="display-5">상품 상세설명</h4>
      <hr class="my-4">
      <p class="lead" th:text="${item.itemDetail}"></p>
    </div>
  </div>

  <div class="text-center" th:each="itemImg : ${item.itemImgDTOList}">
    <!-- 만약 이미지가 고정 값으로 들어가지 않는다면 이거 필요없는 것 아닌가? -->
    <img th:if="${not #strings.isEmpty(itemImg.imgUrl)}"
         th:src="${itemImg.imgUrl}" th:alt="${item.itemNm}" class="rounded mgb-15" width="100%">
  </div>

</div>
</html>